**Props:**

-   **`data`** (`Object` | `null`): An object where keys are group names (e.g., "All Instructors", "Instructor Name") and values are objects containing the calculated statistics for that group. If `null` or `undefined`, a placeholder message is shown.
    -   *Shape:* `{ [groupName: string]: { [statKey: string]: number | string } }`
-   **`errorMessage`** (`string` | `null`): An HTML string containing an error message to be displayed. If present, it takes precedence over all other rendering logic.
-   **`selectedStats`** (`Array<string>`): An array of strings, where each string is a key corresponding to a statistic to be displayed (e.g., `['mean_rating', 'median_rating']`). Defaults to an empty array. This prop determines which columns appear in the table.
-   **`statisticsMetadata`** (`Object`): An object containing metadata for each statistic, used primarily for tooltips. It's structured similarly to the `data` prop but contains metadata objects.
    -   *Shape:* `{ [groupName: string]: { [statKey: string]: { n: number, std: number } } }`
    -   `n`: The sample size for the statistic.
    -   `std`: The standard deviation for the statistic.

---

### State Management

-   **`downloadClicked`** (`boolean`): A state variable initialized to `false`.
    -   **Purpose:** Tracks the state of the download button to provide user feedback.
    -   **Usage:**
        1.  Set to `true` when the download button is clicked.
        2.  Disables the button to prevent multiple rapid clicks.
        3.  Changes the button's content from an icon ('ðŸ“¥') to a checkmark ('âœ…').
        4.  A `setTimeout` resets it to `false` after 2 seconds.

---

### Rendering Logic

#### Conditional Rendering

The component has several rendering paths based on its props:

1.  **Error State:** If `errorMessage` is truthy, the component renders a `div` with the class `data-display-error` and uses `dangerouslySetInnerHTML` to display the HTML-formatted error message. This is the highest priority render path.
2.  **Initial Placeholder:** If `data` is falsy (i.e., `null` or `undefined`), a `div` with the class `data-display-placeholder` is rendered with the text "Enter a course to see the results."
3.  **No Statistics Selected:** If `selectedStats` is falsy or an empty array, a `div` with the class `data-display-placeholder` is rendered with the text "Select at least one statistic to display results."
4.  **Data Table:** If none of the above conditions are met, the component proceeds to render the main data table and download button.

#### Main Table Rendering

-   The component wraps the table in a `div` with the class `data-display`.
-   The table itself is inside a `div.table-container` to allow for potential scrolling or other container-based styling.
-   **Table Headers (`<thead>`):** The headers are generated by the `generateHeaders` function and rendered in a `<tr>`. Each header is a `<th>` element.
-   **Table Body (`<tbody>`):**
    -   The component iterates over the keys of the `data` object (`groups`).
    -   For each `groupName`, a `<tr>` is created.
    -   The first cell (`<td>`) in the row is the `groupName` itself.
    -   The component then maps over the `selectedStats` array. For each `statKey`, it calls the `renderCell` function to create the corresponding `<td>` for that row and column.

---

### Internal Functions

#### `generateHeaders()`

-   **Signature:** `() => Array<string>`
-   **Purpose:** Creates the array of header strings for the data table.
-   **Algorithm:**
    1.  Initializes an array `headers` with the static value `"Group"`.
    2.  Checks if `selectedStats` is a valid, non-empty array.
    3.  Iterates through each `statKey` in `selectedStats`.
    4.  For each `statKey`, it looks up the corresponding human-readable name in the `STAT_MAPPINGS` object.
    5.  If a mapping exists, the human-readable name is pushed to the `headers` array.
-   **Returns:** An array of strings to be used as table headers.

#### `renderCell(groupName, statKey, value)`

-   **Signature:** `(groupName: string, statKey: string, value: number | string) => JSX.Element`
-   **Purpose:** Renders a single table cell (`<td>`), potentially with a tooltip containing additional metadata.
-   **Algorithm:**
    1.  It attempts to find the metadata for the given `groupName` and `statKey` from the `statisticsMetadata` prop.
    2.  **Tooltip Logic:** If the metadata (`details`) exists and contains a non-null `n` (sample size), it renders a `<td>` containing a `<span>` with the class `stat-value`.
        -   The displayed `value` is formatted to two decimal places if it's a number; otherwise, it's displayed as is or as 'N/A' if nullish.
        -   Inside this span, another `<span>` with the class `stat-tooltip` is rendered. This tooltip is typically hidden by CSS and shown on hover.
        -   The tooltip displays the sample size (`n`). If a standard deviation (`std`) is also available, it is appended, formatted to two decimal places.
    3.  **Regular Cell Logic:** If no valid metadata for a tooltip is found, it renders a standard `<td>` with the formatted `value`.
-   **Returns:** A JSX `<td>` element.

#### `convertToCSV()`

-   **Signature:** `() => string`
-   **Purpose:** Converts the `data` object into a single CSV-formatted string.
-   **Algorithm:**
    1.  Initializes an array `rows` and adds the comma-separated `headers` array as the first element.
    2.  Iterates through each `groupName` in the `groups` array.
    3.  For each group, it creates a `row` array, starting with the `groupName` enclosed in double quotes to handle potential commas in the name.
    4.  It then iterates through the `selectedStats` array. For each `statKey`, it retrieves the corresponding `value` from `data[groupName]`.
    5.  The `value` is formatted (to two decimal places for numbers) or converted to an empty string if nullish, and then pushed to the `row` array.
    6.  The `row` array is joined by commas and pushed to the `rows` array.
    7.  Finally, the `rows` array is joined by newline characters (`\n`) to form the complete CSV string.
-   **Returns:** A string containing the data in CSV format.

#### `handleDownload()`

-   **Signature:** `() => void`
-   **Purpose:** Handles the logic for the download button click event.
-   **Algorithm:**
    1.  Sets `downloadClicked` state to `true`.
    2.  Calls `convertToCSV()` to get the data as a string.
    3.  Creates a `Blob` object from the CSV string with the MIME type `text/csv;charset=utf-8;`.
    4.  Creates a temporary `<a>` (link) element in memory.
    5.  Generates a temporary URL for the `Blob` using `URL.createObjectURL()`.
    6.  Sets the `href` of the link to the object URL and the `download` attribute to `course_analysis.csv`.
    7.  Hides the link element, appends it to the `document.body`, programmatically clicks it to trigger the browser's download dialog, and then immediately removes it from the DOM.
    8.  Uses `setTimeout` to reset the `downloadClicked` state to `false` after a 2000ms delay, re-enabling the button and restoring its original icon.
-   **Returns:** `void`.